
// ------------------ SERIAL COMMUNICATION ------------------
// Arduino Mega TX1 (pin 18) -> ESP32 RX (GPIO16)
// Arduino Mega RX1 (pin 19) -> ESP32 TX (GPIO17)
#include <Keypad.h>

// ------------------- KEYPAD CONFIG -------------------
const byte ROWS = 4;
const byte COLS = 4;
char keys[ROWS][COLS] = {
  {'1','2','3','A'},
  {'4','5','6','B'},
  {'7','8','9','C'},
  {'*','0','#','D'}
};
byte rowPins[ROWS] = {22, 23, 24, 25};
byte colPins[COLS] = {26, 27, 28, 29};

Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

// ------------------- BUZZER -------------------
const int buzzerPin = 3; // Mega pin 3

// ------------------- SERIAL & PIN -------------------
const String correctPIN = "5555";
String enteredPIN = "";

void setup() {
  pinMode(buzzerPin, OUTPUT);
  digitalWrite(buzzerPin, LOW);

  Serial.begin(9600);    // For debugging
  Serial1.begin(9600);   // For ESP32

  Serial.println("Keypad Ready. Enter PIN and press #.");
  Serial.println("Press * to clear input.");
}

void loop() {
  char key = keypad.getKey();

  if (key) {
    if (key == '#') {
      if (enteredPIN.length() == 0) {
        Serial.println("No PIN entered.");
        beep(2, 100); // beep twice
      } else {
        String status = (enteredPIN == correctPIN) ? "granted" : "denied";
        
        // JSON payload to ESP32
        String payload = "{\"type\":\"keypad\",\"status\":\"" + status + "\",\"pin\":\"" + enteredPIN + "\"}";
        Serial.println("Sending to ESP32: " + payload);
        Serial1.println(payload);

        // Buzzer feedback
        if (status == "granted") {
          beep(1, 100);  // single short beep
        } else {
          beep(6, 30);  // three short beeps
        }

        enteredPIN = "";
      }
    } 
    else if (key == '*') {
      enteredPIN = "";
      Serial.println("Input cleared.");
      beep(1, 50);  // small confirmation beep
    }
    else if (isdigit(key)) {
      if (enteredPIN.length() < 6) {
        enteredPIN += key;
        Serial.print('*');
      } else {
        Serial.println("Max PIN length reached.");
        beep(2, 50); // short double beep on overflow
      }
    }
    delay(100);
  }

  if (Serial1.available()) {
    String espData = Serial1.readStringUntil('\n');
    espData.trim();
    Serial.print("Received from ESP32: ");
    Serial.println(espData);
  }
}

// ------------------- BUZZER FUNCTION -------------------
void beep(int times, int duration) {
  for (int i = 0; i < times; i++) {
    digitalWrite(buzzerPin, HIGH);
    delay(duration);
    digitalWrite(buzzerPin, LOW);
    delay(100); // pause between beeps
  }
}
